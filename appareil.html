<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche Appareil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">üìä C√¢bles Viewer</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="index.html">üîç Rechercher C√¢ble</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="appareil.html">üì° Rechercher Appareil</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="generate.html">üõ† G√©n√©rer JSON</a>
        </li>
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
    <h1>üì° Rechercher un appareil</h1>
    <div class="input-group mb-4">
      <input type="text" id="appareilInput" class="form-control" placeholder="Nom de l'appareil">
      <button class="btn btn-primary" onclick="searchAppareil()">Rechercher</button>
    </div>
    <div id="resultArea"></div>
  </div>

  <script>
    let db;
    let cablesData = [];

    const request = indexedDB.open("CablesDB", 2);

    request.onupgradeneeded = function (event) {
      db = event.target.result;
      if (!db.objectStoreNames.contains("cables")) {
        db.createObjectStore("cables", { keyPath: "id", autoIncrement: true });
      }
    };

    request.onsuccess = function (event) {
      db = event.target.result;

      if (!db.objectStoreNames.contains("cables")) {
        loadFromJSON();
        return;
      }

      const tx = db.transaction("cables", "readonly");
      const store = tx.objectStore("cables");
      const req = store.getAll();

      req.onsuccess = () => {
        if (req.result.length > 0) {
          cablesData = req.result;
        } else {
          loadFromJSON();
        }
      };
    };

    function loadFromJSON() {
      fetch("cables-min.json")
        .then(res => res.json())
        .then(data => cablesData = data)
        .catch(() => showMessage("‚ùå Impossible de charger les donn√©es", "danger"));
    }

    function searchAppareil() {
      const input = document.getElementById("appareilInput").value.trim().toUpperCase();
      const matches = cablesData.filter(row =>
        String(row.APA || "").toUpperCase() === input ||
        String(row.APO || "").toUpperCase() === input
      );

      if (!matches.length) return showMessage("Aucun c√¢ble trouv√©.", "warning");

      const rows = matches.map(row => {
        const direction = String(row.APA || "").toUpperCase() === input ? "Arriv√©e" : "D√©part";
        return `
          <tr>
            <td>${row.CBL}</td>
            <td>${direction}</td>
            <td>${row.STT_CBL_BORD || "-"}</td>
            <td>${row.PT_CBL || "-"}</td>
            <td>${direction === "Arriv√©e" ? row.LOT_MTG_APA : row.LOT_MTG_APO || "-"}</td>
            <td>${direction === "Arriv√©e" ? row.LOCAL_APA : row.LOCAL_APO || "-"}</td>
          </tr>`;
      }).join("");

      document.getElementById("resultArea").innerHTML = `
        <table class="table table-bordered">
          <thead><tr><th>CBL</th><th>Direction</th><th>Statut</th><th>Type</th><th>Lot</th><th>Local</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;
    }

    function showMessage(msg, type) {
      document.getElementById("resultArea").innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    }
  </script>
</body>
</html>
