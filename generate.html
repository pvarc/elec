<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ğŸ›  GÃ©nÃ©rer et mettre Ã  jour JSON</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Un petit style perso pour le message de chargement */
    #loadingMsg {
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body class="p-4 bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">ğŸ“Š CÃ¢bles Viewer</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">ğŸ” Rechercher CÃ¢ble</a></li>
          <li class="nav-item"><a class="nav-link" href="appareil.html">ğŸ“¡ Rechercher Appareil</a></li>
          <li class="nav-item"><a class="nav-link" href="generate.html">ğŸ›  GÃ©nÃ©rer JSON</a></li>
          <li class="nav-item"><a class="nav-link active" href="rd.html">ğŸ” R&D</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>ğŸ›  GÃ©nÃ©rer des fichiers JSON depuis un fichier NEC (.xlsb)</h1>
    <p>
      Cette page vous permet de crÃ©er un JSON par colonne dâ€™intÃ©rÃªt
      Ã  partir de la feuille <code>Cables</code> de votre fichier <code>.xlsb</code>.<br>
      <strong>Plus tard</strong>, elle servira Ã  mettre Ã  jour le site en se connectant Ã 
      <a href="https://github.com/pvarc/elec/tree/main/json" target="_blank">pvarc/elec/json</a>.
    </p>

    <!-- Bouton pour tÃ©lÃ©charger le fichier NEC si besoin -->
    <a href="https://share.chantiers-atlantique.com/share/proxy/alfresco/slingshot/node/content/workspace/SpacesStore/08213d03-1f34-4cb6-b1c8-ac94778059b8/Extraction_NEC_N34.xlsb?a=true"
       class="btn btn-outline-secondary mb-3"
       target="_blank"
       download>
      ğŸ“¥ TÃ©lÃ©charger le fichier NEC (.xlsb)
    </a>

    <!-- Input file pour charger localement -->
    <input type="file" id="fileInput" accept=".xlsb" class="form-control mb-3">

    <div id="message"></div>
    <div id="loadingMsg"></div>
    <div id="downloadLinks" class="mt-4"></div>
  </div>

  <script>
    // Liste des colonnes d'intÃ©rÃªt (en plus de CBL)
    const columnsOfInterest = [
      "GAM",
      "APO",
      "STT_CBL_BORD",
      "RESP_TIRAGE",
      "LOT_MTG_APO",
      "APA",
      "LOT_MTG_APA",
      "PT_CBL",
      "COD_PLAN",
      "LOCAL_APO",
      "LOCAL_APA"
    ];

    document.getElementById("fileInput").addEventListener("change", handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      showMsg("", "info");
      document.getElementById("loadingMsg").textContent = "â³ Patientez, chargement du fichier en cours...";

      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const buffer = new Uint8Array(evt.target.result);
          parseAndSplitColumns(buffer);
        } catch (err) {
          console.error(err);
          showMsg("âŒ Erreur lecture fichier local : " + err.message, "danger");
        } finally {
          document.getElementById("loadingMsg").textContent = "";
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function parseAndSplitColumns(arrayBuf) {
      try {
        const workbook = XLSX.read(arrayBuf, { type: "array" });
        const sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes("cables"));
        if (!sheetName) {
          showMsg("âŒ Feuille 'Cables' non trouvÃ©e", "danger");
          return;
        }

        const sheet = workbook.Sheets[sheetName];
        const jsonRaw = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        const linksContainer = document.getElementById("downloadLinks");
        linksContainer.innerHTML = "";

        columnsOfInterest.forEach(col => {
          const minimalData = jsonRaw.map(row => ({
            CBL: row["CBL"] || "",
            [col]: row[col] || ""
          }));

          // GÃ©nÃ©rer le blob JSON
          const blob = new Blob(
            [JSON.stringify(minimalData, null, 2)],
            { type: "application/json" }
          );
          const url = URL.createObjectURL(blob);

          const fileName = `cables_${col}.json`;
          const link = document.createElement("a");
          link.href = url;
          link.download = fileName;
          link.className = "btn btn-primary me-2 mb-2";
          link.textContent = `TÃ©lÃ©charger ${fileName}`;

          linksContainer.appendChild(link);
        });

        showMsg(
          `âœ… ${
            jsonRaw.length
          } lignes chargÃ©es. ${columnsOfInterest.length} fichiers gÃ©nÃ©rÃ©s.`,
          "success"
        );
      } catch (err) {
        console.error(err);
        showMsg("âŒ Erreur lors du parse XLSB : " + err.message, "danger");
      }
    }

    // Simple util pour afficher un message
    function showMsg(msg, type = "info") {
      document.getElementById("message").innerHTML =
        `<div class="alert alert-${type}">${msg}</div>`;
    }
  </script>

  <!-- Script Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
