<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>G√©n√©rer et Uploader cables-min.json</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">üìä C√¢bles Viewer</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="index.html">üîç Rechercher C√¢ble</a></li>
          <li class="nav-item"><a class="nav-link" href="appareil.html">üì° Rechercher Appareil</a></li>
          <li class="nav-item"><a class="nav-link active" href="generate.html">üõ† G√©n√©rer JSON</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1 class="mb-3">üîÑ G√©n√©rer et uploader <code>cables-min.json</code></h1>
    <p>
      Cette page permet de r√©cup√©rer le fichier NEC <code>.xlsb</code> 
      soit par URL, soit depuis un fichier local, 
      puis de g√©n√©rer le <code>cables-min.json</code> 
      et enfin de l‚Äôenvoyer automatiquement sur GitHub.
    </p>

    <!-- Bouton pour charger depuis URL -->
    <button class="btn btn-secondary mb-3" id="btnLoadUrl">
      Charger depuis URL
    </button>
    <!-- Input file pour charger localement -->
    <input type="file" id="fileInput" accept=".xlsb" class="form-control mb-3" />

    <div id="message"></div>

    <!-- Bouton pour t√©l√©charger le cables-min.json g√©n√©r√© -->
    <a id="downloadLink" class="btn btn-success mt-3 d-none" download="cables-min.json">
      üì• T√©l√©charger cables-min.json
    </a>

    <!-- Bouton pour Uploader sur GitHub -->
    <button id="uploadBtn" class="btn btn-outline-primary mt-3 ms-2 d-none">
      üì§ Uploader vers GitHub
    </button>
  </div>

  <script>
    // Lien vers ton fichier .xlsb
    const XLSB_URL = "https://share.chantiers-atlantique.com/share/proxy/alfresco/slingshot/node/content/workspace/SpacesStore/08213d03-1f34-4cb6-b1c8-ac94778059b8/Extraction_NEC_N34.xlsb?a=true";

    // Colonnes qu'on veut garder dans cables-min.json
    const colonnesUtile = [
      "CBL", "NAV", "STT_CBL_BORD", "PT_CBL",
      "APA", "LOCAL_APA", "LOT_MTG_APA",
      "APO", "LOCAL_APO", "LOT_MTG_APO"
    ];

    // Config GitHub
    const GITHUB_TOKEN = "TON_TOKEN_ICI";  // <-- Mets ton token GitHub ici
    const GITHUB_OWNER = "pvarc";
    const GITHUB_REPO = "elec";
    const GITHUB_PATH = "cables-min.json";
    const GITHUB_BRANCH = "main";

    let jsonMin = null; // On stockera ici le r√©sultat final

    document.getElementById("btnLoadUrl").addEventListener("click", loadFromUrl);
    document.getElementById("fileInput").addEventListener("change", handleFile);
    document.getElementById("uploadBtn").addEventListener("click", uploadToGitHub);

    // --- 1) Charger depuis URL ---

    async function loadFromUrl() {
      showMsg("‚è≥ Chargement du fichier .xlsb depuis l‚ÄôURL‚Ä¶", "info");
      try {
        const resp = await fetch(XLSB_URL);
        if (!resp.ok) {
          throw new Error("Erreur HTTP " + resp.status);
        }
        const buffer = await resp.arrayBuffer();
        parseXlsb(buffer);
      } catch (err) {
        console.error(err);
        showMsg("‚ùå Erreur lors du chargement depuis l‚ÄôURL : " + err.message, "danger");
      }
    }

    // --- 2) Charger depuis un fichier local ---

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      showMsg("‚è≥ Lecture du fichier local...", "info");

      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const buffer = new Uint8Array(evt.target.result);
          parseXlsb(buffer);
        } catch (err) {
          console.error(err);
          showMsg("‚ùå Erreur lors de la lecture du fichier local", "danger");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // --- 3) Parse du .xlsb en cables-min.json ---

    function parseXlsb(arrayBuf) {
      try {
        // Lire le workbook
        const workbook = XLSX.read(arrayBuf, { type: 'array' });
        // Trouver la feuille "Cables"
        const sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes("cables"));
        if (!sheetName) {
          showMsg("‚ùå Feuille 'Cables' non trouv√©e", "danger");
          return;
        }
        // Extraire en JSON brut
        const sheet = workbook.Sheets[sheetName];
        const jsonRaw = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        // Filtrer les colonnes
        jsonMin = jsonRaw.map(row => {
          const obj = {};
          colonnesUtile.forEach(col => obj[col] = row[col] ?? "");
          return obj;
        });

        // G√©n√©rer un Blob (pour t√©l√©chargement local)
        const blob = new Blob([JSON.stringify(jsonMin, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const link = document.getElementById("downloadLink");
        link.href = url;
        link.classList.remove("d-none");

        // Activer le bouton pour upload GitHub
        document.getElementById("uploadBtn").classList.remove("d-none");

        showMsg(`‚úÖ ${jsonMin.length} lignes extraites. Fichier pr√™t.`, "success");

      } catch (err) {
        console.error(err);
        showMsg("‚ùå Erreur lors du parsing XLSB : " + err.message, "danger");
      }
    }

    // --- 4) Uploader vers GitHub ---

    async function uploadToGitHub() {
      if (!jsonMin) {
        showMsg("‚ùå Aucun JSON g√©n√©r√© √† uploader.", "danger");
        return;
      }

      showMsg("‚è≥ Envoi en cours vers GitHub...", "info");

      try {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(jsonMin, null, 2))));
        // R√©cup√©rer le sha s'il existe d√©j√†
        let sha = null;
        const check = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`, {
          headers: { Authorization: `token ${GITHUB_TOKEN}` }
        });
        if (check.ok) {
          const data = await check.json();
          sha = data.sha;
        }

        // Construire la requ√™te PUT
        const body = {
          message: "üîÑ Mise √† jour automatique cables-min.json",
          content: content,
          branch: GITHUB_BRANCH
        };
        if (sha) body.sha = sha;

        const res = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`, {
          method: "PUT",
          headers: {
            Authorization: `token ${GITHUB_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || "Erreur inconnue");
        }

        const result = await res.json();
        showMsg(
          `‚úÖ Fichier mis √† jour sur GitHub !<br>
           <a href="${result.content.html_url}" target="_blank">üìÑ Voir sur GitHub</a>`,
          "success"
        );

      } catch (err) {
        console.error(err);
        showMsg("‚ùå √âchec de l'upload sur GitHub : " + err.message, "danger");
      }
    }

    // --- Utilitaire pour afficher un message ---
    function showMsg(msg, type = "info") {
      document.getElementById("message").innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
