<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>G√©n√©rer 1 JSON par colonne</title>
  <!-- SheetJS pour lire le .xlsb -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">üìä Split XLSB ‚Üí Multiples JSON</a>
    </div>
  </nav>

  <div class="container">
    <h1 class="mb-3">G√©n√©rer plusieurs fichiers JSON √† partir du NEC</h1>
    <p>
      Cette page va lire la feuille <code>"Cables"</code> de ton fichier <code>.xlsb</code>, et produire
      un fichier JSON par colonne d‚Äôint√©r√™t.<br>
      Chaque JSON contient <code>CBL</code> + la colonne cibl√©e.
    </p>

    <!-- (Optionnel) Bouton pour charger depuis un URL si tu veux -->
    <!-- <button class="btn btn-secondary mb-3" id="btnLoadUrl">Charger depuis URL</button> -->

    <!-- Input file pour charger localement -->
    <input type="file" id="fileInput" accept=".xlsb" class="form-control mb-3">

    <div id="message"></div>

    <div id="downloadLinks" class="mt-4"></div>
  </div>

  <script>
    // URL possible (si tu veux charger depuis un lien direct)
    // const XLSB_URL = "https://share.chantiers-atlantique.com/.../Extraction_NEC_N34.xlsb?a=true";

    // Les 10 colonnes d'int√©r√™t (en plus de 'CBL')
    const columnsOfInterest = [
      "GAM",
      "STT_CBL_BORD",
      "RESP_TIRAGE",
      "LOT_MTG_APO",
      "APA",
      "LOT_MTG_APA",
      "PT_CBL",
      "COD_PLAN",
      "LOCAL_APO",
      "LOCAL_APA"
    ];

    document.getElementById("fileInput").addEventListener("change", handleFile);

    // (Optionnel) Pour charger depuis l'URL, si tu actives le bouton
    // document.getElementById("btnLoadUrl").addEventListener("click", loadFromUrl);

    // --- 1) Charger un fichier local ---
    function handleFile(e) {
      const file = e.target.files[0];
      if (!file) return;

      showMsg("‚è≥ Lecture du fichier local...", "info");

      const reader = new FileReader();
      reader.onload = evt => {
        try {
          const buffer = new Uint8Array(evt.target.result);
          parseAndSplitColumns(buffer);
        } catch (err) {
          console.error(err);
          showMsg("‚ùå Erreur lecture fichier local : " + err.message, "danger");
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // --- 2) (Optionnel) Charger depuis URL ---
    async function loadFromUrl() {
      showMsg("‚è≥ Chargement depuis l'URL...", "info");
      try {
        const resp = await fetch(XLSB_URL);
        if (!resp.ok) {
          throw new Error("Erreur HTTP " + resp.status);
        }
        const arrayBuf = await resp.arrayBuffer();
        parseAndSplitColumns(arrayBuf);
      } catch (err) {
        console.error(err);
        showMsg("‚ùå Erreur : " + err.message, "danger");
      }
    }

    // --- 3) Parser le XLSB, trouver "Cables" et g√©n√©rer 10 JSON distincts ---
    function parseAndSplitColumns(arrayBuf) {
      try {
        const workbook = XLSX.read(arrayBuf, { type: "array" });
        // Feuille "Cables" (insensible √† la casse)
        const sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes("cables"));
        if (!sheetName) {
          showMsg("‚ùå Feuille 'Cables' non trouv√©e", "danger");
          return;
        }

        // Convertir en JSON brut
        const sheet = workbook.Sheets[sheetName];
        const jsonRaw = XLSX.utils.sheet_to_json(sheet, { defval: "" });

        // On va cr√©er un JSON = "cables_<col>.json" pour chaque col
        const linksContainer = document.getElementById("downloadLinks");
        linksContainer.innerHTML = ""; // on vide d'abord

        // Pour chaque colonne d'int√©r√™t
        columnsOfInterest.forEach(col => {
          // On r√©cup√®re un tableau "CBL" + la colonne
          const minimalData = jsonRaw.map(row => {
            return {
              CBL: row["CBL"] || "",
              [col]: row[col] || ""
            };
          });

          // On g√©n√®re un blob JSON
          const blob = new Blob([JSON.stringify(minimalData, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          // On cr√©e un lien de t√©l√©chargement
          const fileName = `cables_${col}.json`;
          const link = document.createElement("a");
          link.href = url;
          link.download = fileName;
          link.className = "btn btn-primary me-2 mb-2";
          link.textContent = `T√©l√©charger ${fileName}`;

          // On l'ajoute √† la page
          linksContainer.appendChild(link);
        });

        showMsg(`‚úÖ ${jsonRaw.length} lignes charg√©es. Fichiers g√©n√©r√©s : ${columnsOfInterest.length}`, "success");
      } catch (err) {
        console.error(err);
        showMsg("‚ùå Erreur lors du parse XLSB : " + err.message, "danger");
      }
    }

    // Simple util pour afficher un message
    function showMsg(msg, type = "info") {
      document.getElementById("message").innerHTML =
        `<div class="alert alert-${type}">${msg}</div>`;
    }
  </script>

  <!-- Script Bootstrap pour la navbar responsive -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
