<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche C√¢ble</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .section-title {
      font-weight: bold;
      font-size: 1.1rem;
      margin-top: 1rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .field {
      margin-bottom: 4px;
    }
  </style>
</head>
<body class="p-4 bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">üìä C√¢bles Viewer</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="index.html">üîç Rechercher C√¢ble</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="appareil.html">üì° Rechercher Appareil</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="upload.html">‚öôÔ∏è Importer Fichier</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

  
  <div class="container">
    <h1 class="mb-4">üîç Rechercher un c√¢ble</h1>

    <div class="input-group mb-4">
      <input type="text" id="cblInput" class="form-control" placeholder="Entrez le code CBL (ex: A4A7CBE)">
      <button class="btn btn-primary" onclick="searchCable()">Rechercher</button>
    </div>

    <div id="resultArea"></div>
    <hr class="my-5">
    <a href="upload.html" class="btn btn-secondary">üì§ Mettre √† jour les donn√©es</a>
  </div>

  <script>
    let db;
    const request = indexedDB.open("CablesDB", 2);

    request.onsuccess = function(event) {
      db = event.target.result;
    };

    function searchCable() {
      const cblCode = document.getElementById('cblInput').value.trim().toUpperCase();
      if (!cblCode) {
        showMessage("Veuillez entrer un code CBL.", "danger");
        return;
      }

      const tx = db.transaction("cables", "readonly");
      const store = tx.objectStore("cables");
      const req = store.getAll();

      req.onsuccess = function() {
        const result = req.result.find(row => (row["CBL"] || "").toUpperCase() === cblCode);
        if (result) {
          renderCableCard(result);
        } else {
          showMessage(`Aucun c√¢ble trouv√© avec le code : ${cblCode}`, "danger");
        }
      };
    }

    function showMessage(msg, type = "info") {
      document.getElementById("resultArea").innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    }

    function renderSection(title, fields, data) {
      return `
        <div class="section">
          <div class="section-title">${title}</div>
          ${fields.map(f => `<div class="field"><strong>${f} :</strong> ${data[f] ?? "-"}</div>`).join("")}
        </div>
      `;
    }

    function renderCableCard(data) {
      const sections = [
        {
          title: "üìå Identit√© du c√¢ble",
          fields: ["CBL", "NAV", "GAM", "IND_GAM", "COD_IND_CBL", "COD_PLAN"]
        },
        {
          title: "üìÖ Dates cl√©s",
          fields: ["DATE_TIR_PLUS_TARD", "DAT_CONT_JAL_CBL", "DATE_BESOIN_URG", "DATE_CREATION", "DATE_LIVRAISON", "DATE_APPEL", "DATE_EDITION_FDC"]
        },
        {
          title: "‚öôÔ∏è Donn√©es techniques",
          fields: ["STT_CBL_BE", "STT_CBL_BORD", "CBL_TGV_BE", "CBL_TGV_BORD", "PRIX_CBL_MAX", "PRIX_CBL_REEL", "LNG_TOTAL", "LNG_THEO", "LNG_TH_x_COEF"]
        },
        {
          title: "üöß Routage & montage",
          fields: ["RESP_TIRAGE", "RESP_ROUT", "COD_ROUTAGE", "CBL_ROUTABLE", "OBJECTIF_ROUTE_CBL", "OBJECTIF_VAL_CBL"]
        },
        {
          title: "üè≠ Appareils / Lot",
          fields: ["APA", "APO", "LOT_MTG_APA", "LOT_MTG_APO", "T_APP_APA", "T_APP_APO", "LOCAL_APA", "LOCAL_APO"]
        }
      ];

      const html = `
        <div class="card border-primary mb-4">
          <div class="card-header bg-primary text-white">
            üîå C√¢ble : ${data["CBL"] || "?"}
          </div>
          <div class="card-body">
            ${sections.map(s => renderSection(s.title, s.fields, data)).join("")}
          </div>
        </div>
      `;

      document.getElementById('resultArea').innerHTML = html;
    }
  </script>
</body>
</html>
